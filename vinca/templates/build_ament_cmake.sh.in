# Generated by vinca http://github.com/RoboStack/vinca.
# DO NOT EDIT!

rm -rf build
mkdir build
cd build

# necessary for correctly linking SIP files (from python_qt_bindings)
export LINK=$CXX

if [[ "$CONDA_BUILD_CROSS_COMPILATION" != "1" ]]; then
  PYTHON_EXECUTABLE=$PREFIX/bin/python
  PKG_CONFIG_EXECUTABLE=$PREFIX/bin/pkg-config
  OSX_DEPLOYMENT_TARGET="10.15"
else
  PYTHON_EXECUTABLE=$BUILD_PREFIX/bin/python
  PKG_CONFIG_EXECUTABLE=$BUILD_PREFIX/bin/pkg-config
  OSX_DEPLOYMENT_TARGET="11.0"
fi

echo "USING PYTHON_EXECUTABLE=${PYTHON_EXECUTABLE}"
echo "USING PKG_CONFIG_EXECUTABLE=${PKG_CONFIG_EXECUTABLE}"

export ROS_PYTHON_VERSION=`$PYTHON_EXECUTABLE -c "import sys; print('%i.%i' % (sys.version_info[0:2]))"`

if [[ $target_platform =~ emscripten.* ]]; then
  # Use emcmake to configure cmake correctly for cross compilation
  # export CMAKE_CMD="emcmake ${CMAKE_CMD}"
  # Set python exe to the binary installed to the build_env
  # export PYTHON_EXECUTABLE=$BUILD_PREFIX/bin/python
  # export PYTHONHOME="$BUILD_PREFIX"
  # export PYTHONPATH="$BUILD_PREFIX:$BUILD_PREFIX/lib/python${ROS_PYTHON_VERSION}/site-packages"
  # echo "Doing some tests with python"
  # $PYTHON_EXECUTABLE -c "import sys; print('sys.prefix:', sys.prefix)"
  # $PYTHON_EXECUTABLE -c "import sys; print('sys.exec_prefix:', sys.exec_prefix)"
  # $PYTHON_EXECUTABLE -c "import sys; print('sys.path:', sys.path)"
  # $PYTHON_EXECUTABLE -c "import site; print('site-packages:', site.getsitepackages())"
  # $PYTHON_EXECUTABLE -c "import site; print('user site-packages:', site.getusersitepackages())"
  # $PYTHON_EXECUTABLE -c "import os; print('os.environ', os.environ)"
  # $PYTHON_EXECUTABLE -c "import ament_package; print(ament_package)"
  # echo "Finished tests with python"

  export EXTRA_CMAKE_ARGS="\
    -DCMAKE_TOOLCHAIN_FILE=~/emsdk/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake \
    -DTHREADS_PREFER_PTHREAD_FLAG=TRUE \
    -DCMAKE_CROSSCOMPILING=TRUE "

   #  -DCMAKE_FIND_USE_CMAKE_ENVIRONMENT_PATH=TRUE \
   #  -DCMAKE_FIND_USE_CMAKE_PATH=TRUE \
   #  -DPython_SITELIB=$SP_DIR \
   #  -DPYTHONHOME=$BUILD_PREFIX \
   #  --debug-output \
   #  --debug-trycompile \
   # "
fi;

export ROS_PYTHON_SP=`$PYTHON_EXECUTABLE -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())"`

echo "Using Python ${ROS_PYTHON_VERSION}"
echo "ROS_PYTHON_SP site-package dir ${ROS_PYTHON_SP}"
echo "SP_DIR site-package dir ${SP_DIR}"

# see https://github.com/conda-forge/cross-python-feedstock/issues/24
if [[ "$CONDA_BUILD_CROSS_COMPILATION" == "1" ]]; then
  find $PREFIX/lib/cmake -type f -exec sed -i "s~\${_IMPORT_PREFIX}/lib/python${ROS_PYTHON_VERSION}/site-packages~${BUILD_PREFIX}/lib/python${ROS_PYTHON_VERSION}/site-packages~g" {} + || true
  find $PREFIX/share/rosidl* -type f -exec sed -i "s~$PREFIX/lib/python${ROS_PYTHON_VERSION}/site-packages~${BUILD_PREFIX}/lib/python${ROS_PYTHON_VERSION}/site-packages~g" {} + || true
  find $PREFIX/share/rosidl* -type f -exec sed -i "s~\${_IMPORT_PREFIX}/lib/python${ROS_PYTHON_VERSION}/site-packages~${BUILD_PREFIX}/lib/python${ROS_PYTHON_VERSION}/site-packages~g" {} + || true
  find $PREFIX/lib/cmake -type f -exec sed -i "s~message(FATAL_ERROR \"The imported target~message(WARNING \"The imported target~g" {} + || true
fi

if [[ $target_platform =~ linux.* ]]; then
    export CFLAGS="${CFLAGS} -D__STDC_FORMAT_MACROS=1"
    export CXXFLAGS="${CXXFLAGS} -D__STDC_FORMAT_MACROS=1"
fi;

# Needed for qt-gui-cpp ..
if [[ $target_platform =~ linux.* ]]; then
  ln -s $GCC ${BUILD_PREFIX}/bin/gcc
  ln -s $GXX ${BUILD_PREFIX}/bin/g++
fi;

cmake \
    -G "Ninja" \
    -DCMAKE_INSTALL_PREFIX=$PREFIX \
    -DCMAKE_PREFIX_PATH=$PREFIX \
    -DAMENT_PREFIX_PATH=$PREFIX \
    -DCMAKE_INSTALL_LIBDIR=lib \
    -DCMAKE_BUILD_TYPE=Release \
    -DPYTHON_EXECUTABLE=$PYTHON_EXECUTABLE \
    -DPython_EXECUTABLE=$PYTHON_EXECUTABLE \
    -DPython3_EXECUTABLE=$PYTHON_EXECUTABLE \
    -DPKG_CONFIG_EXECUTABLE=$PKG_CONFIG_EXECUTABLE \
    -DPYTHON_INSTALL_DIR=$SP_DIR \
    -DSETUPTOOLS_DEB_LAYOUT=OFF \
    -DCATKIN_SKIP_TESTING=$SKIP_TESTING \
    -DCMAKE_INSTALL_SYSTEM_RUNTIME_LIBS_SKIP=True \
    -DBUILD_SHARED_LIBS=ON  \
    -DBUILD_TESTING=OFF \
    -DCMAKE_OSX_DEPLOYMENT_TARGET=$OSX_DEPLOYMENT_TARGET \
    $EXTRA_CMAKE_ARGS \
    $SRC_DIR/$PKG_NAME/src/work

cmake --build . --config Release --target install
